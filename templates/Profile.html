<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kaarya - Profile</title>
    <link href="../static/Profile.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script>
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, '0');
        const dd = String(today.getDate()).padStart(2, '0');
        const minDate = `${yyyy}-${mm}-${dd}`;

        window.onload = function() {
            const dateField = document.getElementById("field6");
            if (dateField) {
                dateField.setAttribute("min", minDate);
            }
        };

        async function fetchCitiesProfile() {
            const pin = document.getElementById("pincode").value;
            const citySelect = document.getElementById("citySelect");
            const loadingIcon = document.getElementById("city-loading");
            
            console.log("fetchCitiesProfile called with PIN:", pin);
            
            if(pin.length < 6) {
                citySelect.innerHTML = "<option value=''>Enter 6-digit PIN first</option>";
                return;
            }
            
            loadingIcon.style.display = 'inline-block';
            citySelect.disabled = true;
            
            try {
                console.log("Sending request to /get_cities with PIN:", pin);
                const response = await fetch("/get_cities", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ pin })
                });
                
                console.log("Response status:", response.status);
                const data = await response.json();
                console.log("Response data:", data);
                
                citySelect.innerHTML = "";

                if(data.cities && data.cities.length === 0){
                    const errorMsg = data.error || "No cities found for this PIN";
                    citySelect.innerHTML = `<option value=''>${errorMsg}</option>`;
                } else if(data.cities && data.cities.length > 0) {
                    citySelect.innerHTML = "<option value=''>Select City</option>";
                    data.cities.forEach(city => {
                        const option = document.createElement("option");
                        option.value = city;
                        option.textContent = city;
                        citySelect.appendChild(option);
                    });
                } else {
                    citySelect.innerHTML = "<option value=''>Error: Invalid response</option>";
                }
            } catch (error) {
                console.error("Error fetching cities:", error);
                citySelect.innerHTML = "<option value=''>Error loading cities</option>";
            } finally {
                loadingIcon.style.display = 'none';
                citySelect.disabled = false;
            }
        }

        function showPassword(fieldId) {
            const field = document.getElementById(fieldId);
            const icon = document.getElementById(fieldId + '-toggle');
            if (field.type === 'password') {
                field.type = 'text';
                icon.className = 'fas fa-eye-slash';
            } else {
                field.type = 'password';
                icon.className = 'fas fa-eye';
            }
        }

        function formatPhoneNumber(input) {
            let value = input.value.replace(/\D/g, '');
            if (value.length > 10) {
                value = value.substring(0, 10);
            }
            if (value.length > 6) {
                value = value.substring(0, 6) + '-' + value.substring(6);
            }
            if (value.length > 3) {
                value = value.substring(0, 3) + '-' + value.substring(3);
            }
            input.value = value;
        }

        function formatAadharNumber(input) {
            let value = input.value.replace(/\D/g, '');
            if (value.length > 12) {
                value = value.substring(0, 12);
            }
            if (value.length > 8) {
                value = value.substring(0, 8) + ' ' + value.substring(8);
            }
            if (value.length > 4) {
                value = value.substring(0, 4) + ' ' + value.substring(4);
            }
            input.value = value;
        }

        function formatPinCode(input) {
            let value = input.value.replace(/\D/g, '');
            if (value.length > 6) {
                value = value.substring(0, 6);
            }
            input.value = value;
        }
    </script>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div class="logo">
                <i class="fas fa-briefcase"></i>
                <span>Kaarya</span>
            </div>
            <nav class="nav-links">
                <a href="{{ url_for('HomePage') }}" class="nav-link">
                    <i class="fas fa-home"></i>
                    Home
                </a>
                <a href="{{ url_for('PostAJob') }}" class="nav-link">
                    <i class="fas fa-plus"></i>
                    Post Job
                </a>
                <div class="dropdown">
                    <button class="user-dropdown">
                        <i class="fas fa-user"></i>
                        {{UserName}}
                        <i class="fas fa-chevron-down"></i>
                    </button>
                    <div class="dropdown-content">
                        <a href="{{ url_for('Upgrade') }}">
                            <i class="fas fa-graduation-cap"></i>
                            Upgrade
                        </a>
                        <a href="{{url_for('MyPosts')}}">
                            <i class="fas fa-list"></i>
                            My Posts
                        </a>
                        <a href="{{ url_for('Signout') }}">
                            <i class="fas fa-sign-out-alt"></i>
                            Sign Out
                        </a>
                    </div>
                </div>
            </nav>
        </div>
    </div>
    
    <div class="main-content">
        <div class="page-header">
            <h1>Update Your Profile</h1>
            <p>Keep your information up to date for better job matches</p>
        </div>
        
        <div class="form-container">
            <form method="POST" class="profile-form">
                <div class="form-section">
                    <div class="section-header">
                        <i class="fas fa-user"></i>
                        <h2>Personal Information</h2>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="name"><i class="fas fa-user"></i> Full Name</label>
                            <input type="text" id="name" name="name" required value="{{ProfileData.NAME}}" autocomplete="name">
                        </div>
                        <div class="form-group">
                            <label for="phone"><i class="fas fa-phone"></i> Contact Number</label>
                            <input type="text" id="phone" name="phone" required value="{{ProfileData.PHONE}}" oninput="formatPhoneNumber(this)" autocomplete="tel">
                        </div>
                        <div class="form-group">
                            <label for="email"><i class="fas fa-envelope"></i> Email Address</label>
                            <input type="email" id="email" name="email" readonly value="{{ProfileData.EMAIL}}" autocomplete="email">
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <div class="section-header">
                        <i class="fas fa-map-marker-alt"></i>
                        <h2>Location Information</h2>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="qualification"><i class="fas fa-graduation-cap"></i> Qualification</label>
                            <input type="text" id="qualification" name="qualification" value="{{ProfileData.QUALIFICATION}}" autocomplete="organization-title">
                        </div>
                        <div class="form-group">
                            <label for="pincode"><i class="fas fa-map-pin"></i> PIN Code</label>
                            <input type="text" id="pincode" name="pincode" required value="{{ProfileData.PINCODE}}" oninput="formatPinCode(this); fetchCitiesProfile();" autocomplete="postal-code">
                        </div>
                        <div class="form-group">
                            <label for="citySelect"><i class="fas fa-city"></i> City</label>
                            <div class="select-container">
                                <select id="citySelect" name="city" required>
                                    <option value="{{ProfileData.ADDRESS}}">{{ProfileData.ADDRESS}}</option>
                                </select>
                                <i class="fas fa-spinner fa-spin" id="city-loading" style="display: none;"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <div class="section-header">
                        <i class="fas fa-lock"></i>
                        <h2>Security Settings</h2>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="oldPassword"><i class="fas fa-key"></i> Old Password</label>
                            <div class="password-container">
                                <input type="password" id="oldPassword" name="oldPassword" autocomplete="current-password">
                                <button type="button" class="password-toggle" onclick="showPassword('oldPassword')">
                                    <i id="oldPassword-toggle" class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="newPassword"><i class="fas fa-lock"></i> New Password</label>
                            <div class="password-container">
                                <input type="password" id="newPassword" name="newPassword" autocomplete="new-password">
                                <button type="button" class="password-toggle" onclick="showPassword('newPassword')">
                                    <i id="newPassword-toggle" class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="aadhar"><i class="fas fa-id-card"></i> Aadhar Number</label>
                            <input type="text" id="aadhar" name="aadhar" readonly value="XXXXXXXXXX{{ProfileData.AADHAR_NO[10:13]}}" oninput="formatAadharNumber(this)">
                        </div>
                    </div>
                </div>

                <div class="submit-section">
                    <button type="submit" class="submit-btn">
                        <i class="fas fa-save"></i>
                        Update Profile
                    </button>
                </div>
            </form>
        </div>
    </div>
</body>
</html>
